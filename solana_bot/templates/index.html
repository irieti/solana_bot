{% extends "base.html" %} {% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-2xl font-bold mb-4">Token Tracker</h2>

    <form id="tracker-form" class="mb-6">
        {% csrf_token %}
        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
            <div>
                <label for="mint-input" class="block mb-2">
                    Token address:
                </label>
                <input
                    type="text"
                    id="mint-input"
                    name="mint"
                    placeholder="Enter token address"
                    class="w-full p-2 border rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                    required
                />
            </div>

            <div>
                <label for="loop-time" class="block mb-2">Loop interval:</label>
                <select
                    name="loop_time"
                    id="loop-time"
                    class="w-full p-2 border rounded"
                >
                    <option value="2">2 sec</option>
                    <option value="3">3 sec</option>
                    <option value="5">5 sec</option>
                    <option value="10">10 sec</option>
                    <option value="60">1 min</option>
                    <option value="3600">1 hour</option>
                </select>
            </div>

            <div class="flex items-end">
                <button
                    type="submit"
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                >
                    Start Tracking
                </button>
            </div>
        </div>
    </form>

    <h3 class="text-xl font-bold mb-4">Active Loops</h3>
    <ul id="active-loops" class="space-y-2">
        <li class="text-gray-500">Loading...</li>
    </ul>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('tracker-form');
        const activeLoopsList = document.getElementById('active-loops');

        // Update active loops list
        function updateActiveLoops() {
            fetch('/get-active-loops/')
                .then((response) => response.json())
                .then((data) => {
                    if (data.loops.length === 0) {
                        activeLoopsList.innerHTML =
                            '<li class="text-gray-500">No active loops</li>';
                        return;
                    }

                    activeLoopsList.innerHTML = data.loops
                        .map(
                            (loop) => `
                    <li class="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span>ðŸ”µ ${loop.mint} (${loop.loop_time} sec)</span>
                        <button 
                            onclick="stopLoop('${loop.mint}')" 
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
                        >
                            Stop
                        </button>
                    </li>
                `
                        )
                        .join('');
                });
        }

        // Start loop
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = {
                mint: document.getElementById('mint-input').value,
                loop_time: document.getElementById('loop-time').value,
            };

            fetch('/start-loop/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector(
                        '[name=csrfmiddlewaretoken]'
                    ).value,
                },
                body: JSON.stringify(formData),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.status === 'success') {
                        updateActiveLoops();
                        form.reset(); // Clear the form after successful submission
                    }
                });
        });

        // Stop loop
        window.stopLoop = function (mint) {
            fetch('/stop-loop/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector(
                        '[name=csrfmiddlewaretoken]'
                    ).value,
                },
                body: JSON.stringify({ mint: mint }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.status === 'success') {
                        updateActiveLoops();
                    }
                });
        };

        // Update active loops every 5 seconds
        setInterval(updateActiveLoops, 5000);
        updateActiveLoops();
    });
</script>
{% endblock %}
