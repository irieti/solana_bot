{% extends "base.html" %} {% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-2xl font-bold mb-4">Token Tracker</h2>

    <form id="tracker-form" class="mb-6">
        {% csrf_token %}
        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
            <div>
                <label for="mint-input" class="block mb-2">
                    Token address:
                </label>
                <input
                    type="text"
                    id="mint-input"
                    name="mint"
                    placeholder="Enter token address"
                    class="w-full p-2 border rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                    required
                />
            </div>

            <div>
                <label for="loop-time" class="block mb-2">Loop interval:</label>
                <select
                    name="loop_time"
                    id="loop-time"
                    class="w-full p-2 border rounded"
                >
                    <option value="2">2 sec</option>
                    <option value="3">3 sec</option>
                    <option value="5">5 sec</option>
                    <option value="10">10 sec</option>
                    <option value="60">1 min</option>
                    <option value="3600">1 hour</option>
                </select>
            </div>

            <div class="flex items-end">
                <button
                    type="submit"
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                >
                    Start Tracking
                </button>
            </div>
        </div>
    </form>

    <h3 class="text-xl font-bold mb-4">Active Loops</h3>
    <ul id="active-loops" class="space-y-2">
        <li class="text-gray-500">Loading...</li>
    </ul>

    <h3 class="text-xl font-bold mb-4">Loop Updates</h3>
    <ul id="loop-updates" class="space-y-2">
        <li class="text-gray-500">Waiting for updates...</li>
    </ul>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('tracker-form');
        const activeLoopsList = document.getElementById('active-loops');

        // Update active loops list
        function updateActiveLoops() {
            fetch('/get-active-loops/')
                .then((response) => response.json())
                .then((data) => {
                    if (data.loops.length === 0) {
                        activeLoopsList.innerHTML =
                            '<li class="text-gray-500">No active loops</li>';
                        return;
                    }

                    activeLoopsList.innerHTML = data.loops
                        .map(
                            (loop) => `
                    <li class="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span>üîµ ${loop.mint} (${loop.loop_time} sec)</span>
                        <button 
                            onclick="stopLoop('${loop.mint}')" 
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
                        >
                            Stop
                        </button>
                    </li>
                `
                        )
                        .join('');
                });
        }

        // Start loop
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = {
                mint: document.getElementById('mint-input').value,
                loop_time: document.getElementById('loop-time').value,
            };

            fetch('/start-loop/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector(
                        '[name=csrfmiddlewaretoken]'
                    ).value,
                },
                body: JSON.stringify(formData),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.status === 'success') {
                        updateActiveLoops();
                        form.reset(); // Clear the form after successful submission
                    }
                });
        });

        // Stop loop
        window.stopLoop = function (mint) {
            fetch('/stop-loop/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector(
                        '[name=csrfmiddlewaretoken]'
                    ).value,
                },
                body: JSON.stringify({ mint: mint }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.status === 'success') {
                        updateActiveLoops();
                    }
                });
        };

        // Update active loops every 5 seconds
        setInterval(updateActiveLoops, 5000);
        updateActiveLoops();
    });

    document.addEventListener('DOMContentLoaded', function () {
        const updatesContainer = document.getElementById('loop-updates');

        function fetchLoopUpdates() {
            fetch('/get-loop-updates/')
                .then((response) => response.json())
                .then((data) => {
                    updatesContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

                    if (
                        !data.updates ||
                        Object.keys(data.updates).length === 0
                    ) {
                        const emptyItem = document.createElement('li');
                        emptyItem.className = 'text-gray-500';
                        emptyItem.textContent = 'Waiting for updates...';
                        updatesContainer.appendChild(emptyItem);
                        return;
                    }

                    Object.values(data.updates).forEach((update) => {
                        const listItem = document.createElement('li');
                        listItem.className =
                            'p-3 bg-gray-100 rounded mb-3 shadow-sm';

                        // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                        listItem.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-lg">${update.mint}</span>
                                <span class="text-sm text-gray-600">${update.time}</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-sm font-medium">${update.reversed_balance_changes || ''}</span>
                            </div>
                            <div class="text-xl font-semibold mb-2">
                                ${update.sign}${update.formatted_total_amount}
                            </div>
                            <div class="text-sm text-gray-700 whitespace-pre-line">
                                ${update.wallet_details}
                            </div>
                        `;

                        updatesContainer.appendChild(listItem);
                    });
                })
                .catch((error) => {
                    console.error('Error fetching updates:', error);
                    updatesContainer.innerHTML = `
                        <li class="p-2 bg-red-100 text-red-700 rounded">
                            Error loading updates. Retrying...
                        </li>
                    `;
                });
        }

        // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        fetchLoopUpdates();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(fetchLoopUpdates, 1000);
    });
</script>
{% endblock %}
